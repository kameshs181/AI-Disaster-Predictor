<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>AI Disaster Predictor ‚Äî Dashboard</title>

  <!-- Tailwind minimal CDN -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Axios -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { background: linear-gradient(to bottom right, #0f172a, #0ea5e9 60%); color: #ffffff; min-height:100vh; font-family:Inter,sans-serif;}
    header { background: linear-gradient(90deg,#0ea5e9,#0284c7); padding: 18px; box-shadow: 0 6px 18px rgba(0,0,0,0.25); }
    header h1 { font-weight: 700; font-size: 1.35rem; color: #042a2b; }
    .card { background: rgba(255,255,255,0.06); border-radius: 12px; padding: 14px; box-shadow: 0 6px 18px rgba(2,6,23,0.35); }
    .pulse-marker { width:22px;height:22px;border-radius:50%;box-shadow:0 0 18px var(--pulse-color,#ff4d4f);background:var(--pulse-color,#ff4d4f);animation:pulse 2s infinite ease-out;border:2px solid rgba(255,255,255,0.9);}
    @keyframes pulse { 0% { transform: scale(1); opacity:1; } 50% { transform: scale(1.8); opacity:0.5; } 100% { transform: scale(1); opacity:1; } }
    .storm-glow { box-shadow:0 0 30px 8px rgba(255,255,255,0.8); animation:glowPulse 1.5s infinite; }
    @keyframes glowPulse { 0%{transform:scale(1);opacity:1;}50%{transform:scale(1.25);opacity:0.6;}100%{transform:scale(1);opacity:1;} }
    .leaflet-control-layers-expanded { background: rgba(2,6,23,0.8); color:white; border-radius:8px; padding:8px; }
    .leaflet-control-layers-list label { color:#f8fafc; }
    #riskChart { background: rgba(255,255,255,0.04); border-radius:10px; padding:6px; }
    @media(max-width:768px){ .grid-cols-3-md{ grid-template-columns: repeat(1, minmax(0,1fr)); } }
  </style>
</head>
<body>
  <header class="flex items-center justify-between px-6">
    <div>
      <h1 class="text-2xl text-white">AI Disaster Predictor Dashboard</h1>
      <p class="text-sm text-white/80 mt-1">Live flood & cyclone monitoring ‚Ä¢ Animated map</p>
    </div>
    <div class="text-right">
      <div class="text-sm text-white/90">Welcome, {{ user or "Guest" }}</div>
      <a href="/logout" class="text-xs text-white/70 hover:text-white">Logout</a>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-6 py-8">
    <!-- input -->
    <section class="flex flex-col md:flex-row items-center gap-4 mb-6">
      <input id="cityInput" class="flex-1 p-3 rounded-md text-black" placeholder="Enter city name" />
      <div class="flex items-center gap-3">
        <button id="predictBtn" class="px-4 py-2 bg-gradient-to-r from-cyan-400 to-blue-600 rounded-md font-semibold shadow-lg" onclick="onPredict()">Predict</button>
        <button id="clearMapBtn" class="px-3 py-2 bg-white/10 rounded-md text-white hover:bg-white/20" onclick="clearMap()">Clear</button>
      </div>
    </section>

    <!-- top panel: weather + risk cards -->
    <section class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
      <div id="weatherPanel" class="card hidden">
        <h3 class="text-lg font-bold mb-2">üå§Ô∏è Live Weather</h3>
        <div id="weatherInfo" class="grid grid-cols-2 gap-2 text-sm text-white/85"></div>
      </div>

      <div id="floodCard" class="card text-center">
        <h3 class="text-lg font-semibold">üåä Flood Risk</h3>
        <div id="floodProb" class="text-2xl font-bold mt-3">-</div>
        <div id="floodRisk" class="text-sm mt-2 text-white/80">-</div>
      </div>

      <div id="cycloneCard" class="card text-center">
        <h3 class="text-lg font-semibold">üå™Ô∏è Cyclone Risk</h3>
        <div id="cycloneProb" class="text-2xl font-bold mt-3">-</div>
        <div id="cycloneRisk" class="text-sm mt-2 text-white/80">-</div>
      </div>
    </section>

    <!-- map and details -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div class="card">
        <h3 class="font-semibold mb-2">üó∫Ô∏è Live Map (toggle overlays)</h3>
        <div id="map" style="height:520px; border-radius:10px;"></div>
      </div>

      <div class="space-y-6">
        <div class="card">
          <h3 class="font-semibold mb-2">üìò Safety Tips</h3>
          <div id="riskDetails" class="text-sm text-white/90 space-y-3">
            <div id="floodDetail">No data yet</div>
            <div id="cycloneDetail">No data yet</div>
          </div>
        </div>

        <div class="card">
          <h3 class="font-semibold mb-2">üìä Historical Disaster Stats</h3>
          <canvas id="riskChart" height="280"></canvas>
        </div>
      </div>
    </section>
  </main>

  <script>
    const PULSE_COLORS = { low:"#34D399", medium:"#F97316", high:"#EF4444" };
    const PREDICT_ENDPOINT = "/predict";
    const HISTORICAL_ENDPOINT = "/historical_stats";
    let map, currentMarker, pulseLayer, cyclonePathLayer, stormMarker, riskChart=null;

    function initMap(){
      const osm = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{ maxZoom:19 });
      map=L.map("map",{center:[20.5937,78.9629],zoom:5,layers:[osm]});
      const baseLayers={"OSM":osm};
      L.control.layers(baseLayers, {}, {collapsed:false}).addTo(map);
    }

    function makePulseIcon(color){
      return L.divIcon({className:'',html:`<div style="--pulse-color:${color}" class="pulse-marker"></div>`,iconSize:[28,28],iconAnchor:[14,14]});
    }

    function animateTo(lat,lon,flood_prob,cyclone_prob,city,weather){
      const severity = (flood_prob>=0.7||cyclone_prob>=0.7)?"high":(flood_prob>=0.4||cyclone_prob>=0.4)?"medium":"low";
      const color = PULSE_COLORS[severity];
      map.flyTo([lat,lon],6,{duration:2.4});
      if(currentMarker) map.removeLayer(currentMarker);
      if(pulseLayer) map.removeLayer(pulseLayer);
      currentMarker=L.marker([lat,lon],{icon:makePulseIcon(color)}).addTo(map)
        .bindPopup(`<b>${city}</b><br>Flood: ${(flood_prob*100).toFixed(1)}%<br>Cyclone: ${(cyclone_prob*100).toFixed(1)}%`).openPopup();
      pulseLayer=L.circle([lat,lon],{color,fillColor:color,fillOpacity:0.14,radius:Math.max(20000,(Math.max(flood_prob,cyclone_prob)*60000))}).addTo(map);
    }

    function clearMap(){
      if(currentMarker){ map.removeLayer(currentMarker); currentMarker=null; }
      if(pulseLayer){ map.removeLayer(pulseLayer); pulseLayer=null; }
      if(cyclonePathLayer){ map.removeLayer(cyclonePathLayer); cyclonePathLayer=null; }
      if(stormMarker){ map.removeLayer(stormMarker); stormMarker=null; }
    }

    function riskText(prob){ return prob<0.4?"Low":prob<0.7?"Medium":"High"; }

    async function onPredict(){
      const city=document.getElementById("cityInput").value.trim();
      if(!city){ alert("Enter a city"); return; }
      const btn=document.getElementById("predictBtn");
      btn.disabled=true; btn.innerText="Predicting...";
      try{
        const res=await axios.post(PREDICT_ENDPOINT,{city});
        const data=res.data;
        if(data.error){ alert(data.error||"Prediction error"); return; }
        document.getElementById("weatherPanel").classList.remove("hidden");
        document.getElementById("weatherInfo").innerHTML=`
          <div><strong>Temp:</strong> ${data.weather.temp} ¬∞C</div>
          <div><strong>Humidity:</strong> ${data.weather.humidity}%</div>
          <div><strong>Pressure:</strong> ${data.weather.pressure} hPa</div>
          <div><strong>Rainfall:</strong> ${data.weather.rainfall} mm</div>
        `;
        document.getElementById("floodProb").innerText=(data.flood_prob*100).toFixed(1)+"%";
        document.getElementById("floodRisk").innerText=data.flood_risk;
        document.getElementById("cycloneProb").innerText=(data.cyclone_prob*100).toFixed(1)+"%";
        document.getElementById("cycloneRisk").innerText=data.cyclone_risk;
        document.getElementById("floodDetail").innerHTML=`<b>Flood</b><br>Rainfall: ${data.weather.rainfall} mm<br>Advice: ${data.flood_risk==='High'?'Evacuate if instructed.':'Be cautious in low areas.'}`;
        document.getElementById("cycloneDetail").innerHTML=`<b>Cyclone</b><br>Pressure: ${data.weather.pressure} hPa<br>Advice: ${data.cyclone_risk==='High'?'Follow shelter orders.':'Stay alert.'}`;
        animateTo(data.weather.lat,data.weather.lon,data.flood_prob,data.cyclone_prob,data.city,data.weather);
        await updateHistoricalChart(city);
      }catch(err){ console.error(err); alert("Prediction failed."); }
      finally{ btn.disabled=false; btn.innerText="Predict"; }
    }

    async function updateHistoricalChart(city){
      try{
        const res = await axios.get(HISTORICAL_ENDPOINT, { params: { city } });
        const rows = res.data || [];
        const labels = rows.map(r => r.year).reverse();
        const flood = rows.map(r => r.floods).reverse();
        const cyclone = rows.map(r => r.cyclones).reverse();
        const ctx = document.getElementById('riskChart').getContext('2d');

        if(riskChart) riskChart.destroy();

        // Gradients per city
        const floodGradient = ctx.createLinearGradient(0, 0, 0, 400);
        const cycloneGradient = ctx.createLinearGradient(0, 0, 0, 400);
        if(city.toLowerCase() === "mumbai"){
          floodGradient.addColorStop(0, 'rgba(0, 153, 255, 0.9)');
          floodGradient.addColorStop(1, 'rgba(0, 51, 204, 0.5)');
          cycloneGradient.addColorStop(0, 'rgba(255, 99, 132, 0.9)');
          cycloneGradient.addColorStop(1, 'rgba(204, 0, 102, 0.5)');
        } else if(city.toLowerCase() === "delhi"){
          floodGradient.addColorStop(0, 'rgba(34,197,94,0.9)');
          floodGradient.addColorStop(1, 'rgba(16,185,129,0.5)');
          cycloneGradient.addColorStop(0, 'rgba(251,191,36,0.9)');
          cycloneGradient.addColorStop(1, 'rgba(245,158,11,0.5)');
        } else {
          floodGradient.addColorStop(0, 'rgba(96,165,250,0.9)');
          floodGradient.addColorStop(1, 'rgba(59,130,246,0.5)');
          cycloneGradient.addColorStop(0, 'rgba(251,113,133,0.9)');
          cycloneGradient.addColorStop(1, 'rgba(220,38,127,0.5)');
        }

        riskChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels,
            datasets: [
              { label: 'üåä Floods', data: flood, backgroundColor: floodGradient, borderRadius: 12, borderSkipped: false },
              { label: 'üå™Ô∏è Cyclones', data: cyclone, backgroundColor: cycloneGradient, borderRadius: 12, borderSkipped: false }
            ]
          },
          options: {
            responsive: true,
            animation: { duration: 2000, easing: 'easeOutBounce' },
            plugins: {
              legend: { position: 'top', labels: { font: { size: 14 } } },
              title: { display: true, text: `üìä Historical Disaster Statistics ‚Äî ${city}`, font: { size: 18, weight: 'bold' }, padding: { top: 10, bottom: 20 } }
            },
            scales: { x: { grid: { display: false }, ticks: { font: { size: 13 } } }, y: { beginAtZero: true, ticks: { stepSize: 2 } } }
          }
        });
      } catch(err){ console.error("Historical chart failed", err); }
    }

    (function(){ initMap(); })();
  </script>
</body>
</html>
